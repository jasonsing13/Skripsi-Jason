<head>
    <meta charset="UTF-8">
    <title>Vendor Scoring</title>
    <%- include('partials/head.ejs') %>
</head>

<body>
    <%- include('partials/sidebar.ejs') %>
        <div class="container p-4">
            <h2>Vendor Scoring</h2>
            <p>Scoring vendor berdasarkan hasil pengadaan</p>
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Detail Vendor</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <label>Nama Perusahaan</label>
                            <input class="form-control" type="text" placeholder="PT. Vendoria Sejahtera" readonly value="<%= vendor.nama_vendor %>">
                        </div>
                        <div class="col">
                            <label>Nomor Pengadaan</label>
                            <input class="form-control" type="text" placeholder="MML-AX-001" readonly value="<%= pengadaan_id %>">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <div class="row">
                                <div class="col">
                                    <h5>Kriteria Teknikal</h5>
                                </div>
                                <div class="col">
                                    <button type="button" onclick="tambahCard('teknikal')" class="btn btn-<%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'disabled' : 'primary' %> float-end" <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'disabled' : '' %>>Tambah</button>
                                </div>
                            </div>
                        </div>


                        <div class="card-body" id="teknikal">
                            <div class="row">
                                <div class="col">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text">Bobot</span>
                                        <input class="form-control qtyPercent bobot m-0" onchange="calculateScore(1)" placeholder="0-100%" type="text" id="teknikal-bobot" required <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'readonly' : '' %> value="<%= vendorS.bobot_teknikal %>">
                                    </div>
                                </div>
                            </div>
                            <% var total = 0 %>
                            <% vendorSD.forEach((sd, i) => { %>
                                <% if (sd.type == 1) { %>
                                    <% total += parseFloat(sd.score1) + parseFloat(sd.score2) %>
                                    <div class="card mb-3" id="teknikal-<%= i+1 %>">
                                        <div class="card-header">
                                            <div class="row">
                                                <div class="col-8">
                                                    <div class="form-group">
                                                        <label for="nama-kriteria">Nama Template</label>
                                                        <input class="form-control template" onchange="getTemplate(this)" type="text" id="teknikal-template-<%= i+1 %>" list="dlTemplate" required <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'readonly' : '' %> value="<%= sd.nama_template %>">
                                                    </div>
                                                </div>
                                                <div class="col-3 text-center align-content-center">
                                                    Score
                                                </div>
                                                <div class="col">
                                                    <% if (parent.role_id == '123e4567-e89b-12d3-a456-426614174001') { %>
                                                        <button type="button" onclick="delCard('teknikal-<%= i+1 %>')" class="btn float-end p-0"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m6.4 18.308l-.708-.708l5.6-5.6l-5.6-5.6l.708-.708l5.6 5.6l5.6-5.6l.708.708l-5.6 5.6l5.6 5.6l-.708.708l-5.6-5.6z"/></svg></button>
                                                    <% } %>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col">
                                                    <div class="form-group">
                                                        <label for="my-input">Description</label>
                                                        <textarea class="form-control" name="templateDesc" id="teknikal-desc-<%= i+1 %>" <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'disabled' : '' %>><%= sd.deskripsi_template %></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-8">
                                                    <input class="form-control kriteria" id="teknikal-kriteria-<%= i+1 %>" type="text" <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'readonly' : '' %> value="<%= detailVS[sd.template_vs_id].nama_kriteria %>">
                                                </div>
                                                <div class="col">
                                                    <input class="form-control qty teknikal-bobot" onchange="calculateScore(1)" placeholder="1-5" type="text" id="teknikal-bobot-<%= i+1 %>" required <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'readonly' : '' %> value="<%= sd.score1 %>">
                                                </div>
                                            </div>
                
                                            <div class="row">
                                                <div class="col-8">
                                                    <input class="form-control subKriteria" id="teknikal-subkriteria-<%= i+1 %>" type="text" <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'readonly' : '' %> value="<%= detailVS[sd.template_vs_id].nama_sub_kriteria %>">
                                                </div>
                                                <div class="col">
                                                    <input class="form-control qty teknikal-bobot" onchange="calculateScore(1)" placeholder="1-5" type="text" id="teknikal-bobot2-<%= i+1 %>" required <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'readonly' : '' %> value="<%= sd.score2 %>">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            <% }) %>
                        </div>
                        <div class="card-footer">
                            <div class="row">
                                <div class="col-8">
                                    <p>TECHNICAL SCORE</p>
                                </div>
                                <div class="col">
                                    <input style="background-color: #FCE2D3;" class="form-control qty score" type="text" id="bobot-technical-score" readonly value="<%= total*vendorS.bobot_teknikal/100 %>">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <div class="row">
                                <div class="col">
                                    <h5>Kriteria Komersil</h5>
                                </div>
                                <div class="col">
                                    <button type="button" onclick="tambahCard('komersil')" class="btn btn-<%= parent.role_id != '123e4567-e89b-12d3-a456-426614174002' ? 'disabled' : 'primary' %> float-end" <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174002' ? 'disabled' : '' %>>Tambah</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body" id="komersil">
                            <div class="row">
                                <div class="col">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text">Bobot</span>
                                        <input class="form-control qtyPercent bobot m-0" onchange="calculateScore(2)" placeholder="0-100%" type="text" id="komersil-bobot" required <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174002' ? 'readonly' : '' %> value="<%= vendorS.bobot_komersial %>">
                                    </div>
                                </div>
                            </div>
                            <% var total2 = 0 %>
                            <% vendorSD.forEach((sd, i) => { %>
                                <% if (sd.type == 2) { %>
                                    <% total2 += parseFloat(sd.score1) + parseFloat(sd.score2) %>
                                    <div class="card mb-3" id="komersil-<%= i+1 %>">
                                        <div class="card-header">
                                            <div class="row">
                                                <div class="col-8">
                                                    <div class="form-group">
                                                        <label for="nama-kriteria">Nama Template</label>
                                                        <input class="form-control template" onchange="getTemplate(this)" type="text" id="komersil-template-<%= i+1 %>" list="dlTemplate" required <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174002' ? 'readonly' : '' %> value="<%= sd.nama_template %>"">
                                                    </div>
                                                </div>
                                                <div class="col-3 text-center align-content-center">
                                                    Score
                                                </div>
                                                <div class="col">
                                                    <% if (parent.role_id == '123e4567-e89b-12d3-a456-426614174002') { %>
                                                        <button type="button" class="btn float-end p-0" onclick="delCard('komersil-<%= i+1 %>')"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m6.4 18.308l-.708-.708l5.6-5.6l-5.6-5.6l.708-.708l5.6 5.6l5.6-5.6l.708.708l-5.6 5.6l5.6 5.6l-.708.708l-5.6-5.6z"/></svg></button>
                                                    <% } %>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col">
                                                    <div class="form-group">
                                                        <label for="my-input">Description</label>
                                                        <textarea class="form-control" name="templateDesc" id="komersil-desc-<%= i+1 %>" <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174002' ? 'disabled' : '' %>><%= sd.deskripsi_template %></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-8">
                                                    <input class="form-control kriteria" id="komersil-kriteria-<%= i+1 %>" type="text" <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174002' ? 'readonly' : '' %> value="<%= detailVS[sd.template_vs_id].nama_kriteria %>">
                                                </div>
                                                <div class="col">
                                                    <input class="form-control qty komersil-bobot" onchange="calculateScore(2)" placeholder="1-5" type="text" id="komersil-bobot-<%= i+1 %>" required <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174002' ? 'readonly' : '' %> value="<%= sd.score1 %>">
                                                </div>
                                            </div>
                
                                            <div class="row">
                                                <div class="col-8">
                                                    <input class="form-control subKriteria" id="komersil-subkriteria-<%= i+1 %>" type="text" <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174002' ? 'readonly' : '' %> value="<%= detailVS[sd.template_vs_id].nama_sub_kriteria %>">
                                                </div>
                                                <div class="col">
                                                    <input class="form-control qty komersil-bobot" onchange="calculateScore(2)" placeholder="1-5" type="text" id="komersil-bobot2-<%= i+1 %>" required <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174002' ? 'readonly' : '' %> value="<%= sd.score2 %>">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            <% }) %>
                        </div>
                        <div class="card-footer">
                            <div class="row">
                                <div class="col-8">
                                    <p>COMMERCIAL SCORE</p>
                                </div>
                                <div class="col">
                                    <input style="background-color: #FCE2D3;" class="form-control qty score" type="text" id="bobot-commercial-score" readonly value="<%= total2*vendorS.bobot_komersial/100 %>">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">
                    <h5>User Opinion</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <label>Admin Divisi</label>
                            <textarea class="form-control" type="text" placeholder="Opini Admin Divisi" <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'readonly' : '' %>><%= vendorS.desc_teknikal %></textarea>
                        </div>
                        <div class="col">
                            <label>Admin Purchasing</label>
                            <textarea class="form-control" type="text" placeholder="Opini Admin Purchasing" <%= parent.role_id != '123e4567-e89b-12d3-a456-426614174002' ? 'readonly' : '' %>><%= vendorS.desc_komersil %></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Hasil Akhir</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-4">
                            <label>FINAL SCORE</label>
                        </div>
                        <div class="col-2">
                            <input style="background-color: #FCE2D3;" class="form-control qty" type="text" id="final-score" readonly value="<%= vendorS.final_score %>">
                        </div>
                        <button type="submit" class="col-6 btn btn-orange">Submit Scoring</button>
                    </div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <label for="my-input">Admin Divisi</label>
                                <input id="my-input" class="form-control" type="text" disabled value="<%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'Submitted' : 'Pending' %>">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label for="my-input">Admin Purchasing</label>
                                <input id="my-input" class="form-control" type="text" disabled value="<%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'Submitted' : 'Pending' %>">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label for="my-input">Division Head</label>
                                <input id="my-input" class="form-control" type="text" disabled value="<%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'Approved' : 'Pending' %>">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label for="my-input">Department Head</label>
                                <input id="my-input" class="form-control" type="text" disabled value="<%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'Approved' : 'Pending' %>">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label for="my-input">Presiden Direktur</label>
                                <input id="my-input" class="form-control" type="text" disabled value="<%= parent.role_id != '123e4567-e89b-12d3-a456-426614174001' ? 'Approved' : 'Pending' %>">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <datalist id="dlTemplate">
            <% template.forEach(t => { %>
                <option value="<%= t.nama_template %>"><%= t.nama_template %> | <%= t.deskripsi_template %></option>
            <% }) %>
        </datalist>
    <%- include('partials/footer.ejs') %>
    <script>
        function getTemplate(elm) { 
            // GET ID
            var tipe = $(elm)[0].id.split('-')[0];
            var counter = $(elm)[0].id.split('-')[2];
            var val1_id = $('#'+tipe+"-"+counter).find('.kriteria')[0].id;
            var val2_id = $('#'+tipe+"-"+counter).find('.subKriteria')[0].id;
            $.ajax({
                type: "post",
                url: "/api/getDetailVsTemplate",
                data: {
                    nama_template: $(elm).val()
                },
                success: function (response) {
                    if(response){
                        $('#'+val1_id).val(response.nama_kriteria)
                        $('#'+val2_id).val(response.nama_sub_kriteria)
                        $('#'+tipe+"-desc-"+counter).val(response.deskripsi_template)
                        $('#'+val1_id).attr('readonly', true);
                        $('#'+val2_id).attr('readonly', true);
                        $('#'+tipe+"-desc-"+counter).attr('disabled', true);
                    }else{
                        $('#'+val1_id).val('')
                        $('#'+val2_id).val('')
                        $('#'+tipe+"-desc-"+counter).val('')
                        $('#'+val1_id).attr('readonly', false);
                        $('#'+val2_id).attr('readonly', false);
                        $('#'+tipe+"-desc-"+counter).attr('disabled', false);
                    }
                }
            });
        }

        function tambahCard(type){
            var card = $("#"+type)
            var lastID = 0
            var lastCard = "";
            if(card.children('.card:last').length != 0){
                var lastCard = card.children('.card:last')[0].id.split("-")
                lastID = parseInt(lastCard.pop())
            }
            var typeCal = type == 'komersil' ? 2 : 1

            card.append(`
                <div class="card mb-3" id="`+type+`-`+(lastID+1)+`">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-8">
                                <div class="form-group">
                                    <label for="nama-kriteria">Nama Template</label>
                                    <input class="form-control template" onchange="getTemplate(this)" type="text" id="`+type+`-template-`+(lastID+1)+`" list="dlTemplate" required>
                                </div>
                            </div>
                            <div class="col-3 text-center align-content-center">
                                Score
                            </div>
                            <div class="col">
                                <button type="button" onclick="delCard('`+type+`-`+(lastID+1)+`')" class="btn float-end p-0"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="m6.4 18.308l-.708-.708l5.6-5.6l-5.6-5.6l.708-.708l5.6 5.6l5.6-5.6l.708.708l-5.6 5.6l5.6 5.6l-.708.708l-5.6-5.6z"/></svg></button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="my-input">Description</label>
                                    <textarea class="form-control" name="templateDesc" id="`+type+`-desc-`+(lastID+1)+`"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <input class="form-control kriteria" id="`+type+`-kriteria-`+(lastID+1)+`" type="text">
                            </div>
                            <div class="col">
                                <input class="form-control qty `+type+`-bobot" onchange="calculateScore(`+typeCal+`)" placeholder="1-5" type="text" id="`+type+`-bobot-`+(lastID+1)+`" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-8">
                                <input class="form-control subKriteria" id="`+type+`-subkriteria-`+(lastID+1)+`" type="text">
                            </div>
                            <div class="col">
                                <input class="form-control qty `+type+`-bobot" onchange="calculateScore(`+typeCal+`)" placeholder="1-5" type="text" id="`+type+`-bobot2-`+(lastID+1)+`" required>
                            </div>
                        </div>
                    </div>
                </div>
            `)
        }

        function delCard(id){
            $("#"+id).remove();

            calculateScore(id.split('-')[0] == 'komersil' ? 2 : 1);
        }

        function calculateScore(type){
            switch(type){
                case 1:
                    var bobot = parseFloat(initAutoNumeric('#teknikal-bobot', "qtyPercent").getNumericString()) || 0;
                    var total = 0;
                    $('.teknikal-bobot').each(function(i, e){
                        total += parseFloat(initAutoNumeric('#'+$(this)[0].id, "qty").getNumericString()) || 0
                    })
                    var score = initAutoNumeric('#bobot-technical-score', "qty")

                    score.set(total*bobot/100)
                    break;
                case 2:
                    var bobot = parseFloat(initAutoNumeric('#komersil-bobot', "qtyPercent").getNumericString()) || 0;
                    var total = 0;
                    $('.komersil-bobot').each(function(i, e){
                        total += parseFloat(initAutoNumeric('#'+$(this)[0].id, "qty").getNumericString()) || 0
                    })
                    var score = initAutoNumeric('#bobot-commercial-score', "qty")

                    score.set(total*bobot/100)
                    break;
            }

            calculateFinalScore()
        }

        function calculateFinalScore() {
            var val1 = parseFloat(initAutoNumeric('#bobot-commercial-score', "qty").getNumericString()) || 0
            var val2 = parseFloat(initAutoNumeric('#bobot-technical-score', "qty").getNumericString()) || 0
            var score = initAutoNumeric('#final-score', "qty")

            score.set(val1+val2)
        }
    </script>
</body>